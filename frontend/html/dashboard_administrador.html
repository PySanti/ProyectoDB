<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador - ACAUCAB</title>
    <link rel="stylesheet" href="../css/dashboard_gestion_ordenes_compra.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <h1>ACAUCAB</h1>
                <p>Panel de Administración</p>
            </div>
            <div class="sidebar-user">
                <div class="user-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="user-info">
                    <h3 id="nombre-usuario">Administrador</h3>
                    <p id="email-usuario">Superusuario</p>
                </div>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active"><a href="#usuarios" data-section="usuarios"><i class="fas fa-users"></i> Usuarios</a></li>
                    <li><a href="#roles" data-section="roles"><i class="fas fa-user-tag"></i> Roles</a></li>
                    <li><a href="#ordenes" data-section="ordenes"><i class="fas fa-clipboard-list"></i> Órdenes</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span></a>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="dashboard-content">
            <header class="content-header">
                <div class="header-left">
                    <button class="toggle-sidebar"><i class="fas fa-bars"></i></button>
                    <h2>Panel de Administrador</h2>
                </div>
                <div class="header-right">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar usuario, rol u orden...">
                        <button><i class="fas fa-search"></i></button>
                    </div>
                    <div class="notifications">
                        <button class="notification-btn"><i class="fas fa-bell"></i><span class="badge">5</span></button>
                    </div>
                </div>
            </header>
            <!-- Usuarios Section -->
            <section class="content-section active" id="usuarios-section">
                <div class="section-header">
                    <h2>Usuarios</h2>
                    <button class="primary-btn" id="add-usuario-btn"><i class="fas fa-plus"></i> Nuevo Empleado</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Lista de Usuarios</h3>
                        <div class="card-actions">
                            <select id="filter-rol">
                                <option value="admin">Empleado</option>
                                <option value="proveedor">Proveedor</option>
                                <option value="cliente_natural">Cliente Natural</option>
                                <option value="cliente_juridico">Cliente Juridico</option>
                            </select>
                            <button class="export-btn"><i class="fas fa-download"></i> Exportar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Estado</th>
                                    <th>Fecha Creación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Roles Section -->
            <section class="content-section" id="roles-section">
                <div class="section-header">
                    <h2>Roles y Privilegios</h2>
                    <button class="primary-btn" id="add-rol-btn"><i class="fas fa-plus"></i> Nuevo Rol</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Gestión de Roles</h3>
                        <div class="card-actions">
                            <button class="export-btn"><i class="fas fa-download"></i> Exportar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID Rol</th>
                                    <th>Nombre</th>
                                    <th>Privilegios</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Órdenes Section -->
            <section class="content-section" id="ordenes-section">
                <div class="section-header">
                    <h2>Órdenes</h2>
                </div>
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-icon info"><i class="fas fa-warehouse"></i></div>
                        <div class="card-info">
                            <h3>Órdenes de Reposición de Anaqueles</h3>
                            <p>Gestión y seguimiento de reposición en anaqueles.</p>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon warning"><i class="fas fa-truck"></i></div>
                        <div class="card-info">
                            <h3>Órdenes de Reposición a Proveedores</h3>
                            <p>Gestión y seguimiento de reposición a proveedores.</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Órdenes Recientes</h3>
                        <div class="card-actions">
                            <button class="export-btn"><i class="fas fa-download"></i> Exportar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID Orden</th>
                                    <th>Tipo</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ORD-ANA-001</td>
                                    <td>Anaqueles</td>
                                    <td>20/06/2025</td>
                                    <td><span class="status pending">Pendiente</span></td>
                                    <td class="actions">
                                        <button class="action-btn view" title="Ver detalles"><i class="fas fa-eye"></i></button>
                                        <button class="action-btn edit" title="Editar"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>ORD-PROV-002</td>
                                    <td>Proveedor</td>
                                    <td>19/06/2025</td>
                                    <td><span class="status success">Completada</span></td>
                                    <td class="actions">
                                        <button class="action-btn view" title="Ver detalles"><i class="fas fa-eye"></i></button>
                                        <button class="action-btn edit" title="Editar"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>ORD-ANA-003</td>
                                    <td>Anaqueles</td>
                                    <td>18/06/2025</td>
                                    <td><span class="status pending">Pendiente</span></td>
                                    <td class="actions">
                                        <button class="action-btn view" title="Ver detalles"><i class="fas fa-eye"></i></button>
                                        <button class="action-btn edit" title="Editar"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Modal para detalles de usuario -->
    <div id="usuario-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2>Detalles del Usuario</h2>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- Modal para Nuevo/Editar Rol -->
    <div id="rol-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-rol-modal">&times;</span>
            <h2 id="rol-modal-title">Nuevo Rol</h2>
            <form id="rol-form">
                <div class="form-group">
                    <label for="rol-nombre">Nombre del Rol</label>
                    <input type="text" id="rol-nombre" required />
                </div>
                <div class="form-group">
                    <label>Permisos</label>
                    <div class="permisos-checkboxes" style="display:flex; flex-direction:column;">
                        <label><input type="checkbox" name="crear" /> Crear</label>
                        <label><input type="checkbox" name="eliminar" /> Eliminar</label>
                        <label><input type="checkbox" name="actualizar" /> Actualizar</label>
                        <label><input type="checkbox" name="leer" /> Leer</label>
                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 1rem;">
                    <button type="submit" class="primary-btn">Guardar Rol</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para asignar rol a usuario empleado -->
    <div id="asignar-rol-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-asignar-rol-modal">&times;</span>
            <h2>Asignar Rol a <span id="nombre-usuario-rol"></span></h2>
            <form id="asignar-rol-form">
                <div class="form-group">
                    <label for="select-rol">Rol:</label>
                    <select id="select-rol" name="rol"></select>
                </div>
                <div class="modal-footer" style="padding-top: 1rem;">
                    <button type="submit" class="primary-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para crear nuevo empleado -->
    <div id="nuevo-empleado-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-nuevo-empleado-modal">&times;</span>
            <h2>Nuevo Empleado</h2>
            <form id="nuevo-empleado-form">
                <fieldset>
                    <legend>Datos de usuario</legend>
                    <div class="form-group">
                        <label for="nuevo-usuario-correo">Correo electrónico</label>
                        <input type="email" id="nuevo-usuario-correo" name="correo" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-usuario-contrasena">Contraseña</label>
                        <input type="password" id="nuevo-usuario-contrasena" name="contrasena" required>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Datos del empleado</legend>
                    <div class="form-group">
                        <label for="nuevo-empleado-cedula">Cédula</label>
                        <input type="text" id="nuevo-empleado-cedula" name="cedula" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-primer-nombre">Primer nombre</label>
                        <input type="text" id="nuevo-empleado-primer-nombre" name="primer_nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-segundo-nombre">Segundo nombre</label>
                        <input type="text" id="nuevo-empleado-segundo-nombre" name="segundo_nombre">
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-primer-apellido">Primer apellido</label>
                        <input type="text" id="nuevo-empleado-primer-apellido" name="primer_apellido" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-segundo-apellido">Segundo apellido</label>
                        <input type="text" id="nuevo-empleado-segundo-apellido" name="segundo_apellido">
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-direccion">Dirección específica</label>
                        <textarea id="nuevo-empleado-direccion" name="direccion" rows="2" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-estado">Estado</label>
                        <select id="nuevo-empleado-estado" name="estado" required></select>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-municipio">Municipio</label>
                        <select id="nuevo-empleado-municipio" name="municipio" required></select>
                    </div>
                    <div class="form-group">
                        <label for="nuevo-empleado-parroquia">Parroquia</label>
                        <select id="nuevo-empleado-parroquia" name="parroquia" required></select>
                    </div>
                </fieldset>
                <div class="modal-footer" style="padding-top: 1rem;">
                    <button type="submit" class="primary-btn">Crear Empleado</button>
                </div>
            </form>
        </div>
    </div>
    
    <style>
        .modal { 
            position: fixed; 
            z-index: 9999; 
            left: 0; 
            top: 0; 
            width: 100vw; 
            height: 100vh; 
            overflow: auto; 
            background: rgba(0,0,0,0.4); 
            display: none; 
            align-items: center; 
            justify-content: center; 
        }
        .modal.active { 
            display: flex; 
        }
        .modal-content { 
            background: #fff; 
            padding: 2rem; 
            border-radius: 8px; 
            max-width: 95vw; 
            width: 100%; 
            max-width: 500px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
            position: relative; 
        }
        .close-modal { 
            position: absolute; 
            top: 10px; 
            right: 20px; 
            font-size: 2rem; 
            cursor: pointer; 
        }
        @media (max-width: 600px) {
            .modal-content { 
                padding: 1rem; 
                max-width: 98vw; 
            }
        }
        .action-btn.assign-role {
            background: #f0ad4e;
            color: #fff;
            border: none;
            margin-left: 5px;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
        }
        .action-btn.assign-role i {
            font-size: 1.1em;
        }
        #nuevo-empleado-modal .form-group {
            margin-bottom: 1rem;
        }
        #nuevo-empleado-modal fieldset {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            padding: 1rem;
        }
        #nuevo-empleado-modal legend {
            font-weight: bold;
            color: #333;
            padding: 0 0.5rem;
        }
    </style>
    
    <script src="../js/lugares.js"></script>
    <script>
        // Variables globales
        let usuarios = [];
        let editingRoleId = null;
        let usuarioSeleccionadoId = null;

        // Función global para editar un rol
        function editRole(id, nombre, privilegios) {
            console.log('editRole llamado con:', { id, nombre, privilegios });
            editingRoleId = id;
            
            // Llenar el formulario con los datos del rol
            document.getElementById('rol-nombre').value = nombre;
            
            // Marcar los checkboxes según los privilegios actuales
            document.querySelector('#rol-form input[name="crear"]').checked = privilegios.includes('crear');
            document.querySelector('#rol-form input[name="eliminar"]').checked = privilegios.includes('eliminar');
            document.querySelector('#rol-form input[name="actualizar"]').checked = privilegios.includes('actualizar');
            document.querySelector('#rol-form input[name="leer"]').checked = privilegios.includes('leer');
            
            // Cambiar el título del modal
            document.getElementById('rol-modal-title').textContent = 'Editar Rol';
            
            // Mostrar el modal
            document.getElementById('rol-modal').classList.add('active');
            console.log('Modal abierto, editingRoleId:', editingRoleId);
        }

        // Función para resetear el modal de roles
        function resetRolModal() {
            editingRoleId = null;
            document.getElementById('rol-form').reset();
            document.getElementById('rol-modal-title').textContent = 'Crear Nuevo Rol';
            document.getElementById('rol-modal').classList.remove('active');
        }

        // Función para mostrar modal de usuario
        function mostrarModal(tipo, idx) {
            const usuarios = JSON.parse(localStorage.getItem('users_list'));
            let u = null;
            if (tipo === 'empleado') u = usuarios['empleados'][idx];
            if (tipo === 'proveedor') u = usuarios['proveedores'][idx];
            if (tipo === 'cliente_natural') u = usuarios['clientes_naturales'][idx];
            if (tipo === 'cliente_juridico') u = usuarios['clientes_juridicos'][idx];
            if (!u) return;
            
            let html = '<table style="width:100%">';
            for (const key in u) {
                if (key.includes('estado') || key.includes('municipio') || key.includes('parroquia')) {
                    html += `<tr><td style='font-weight:bold;text-transform:capitalize;'>${key.replace(/_/g,' ')}</td><td>${u[key] ?? ''}</td></tr>`;
                } else {
                    html += `<tr><td style='font-weight:bold;text-transform:capitalize;'>${key.replace(/_/g,' ')}</td><td>${u[key] ?? ''}</td></tr>`;
                }
            }
            html += '</table>';
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('usuario-modal').classList.add('active');
        }

        // Función para renderizar tabla de usuarios
        function renderUsuariosTable() {
            const filter = document.getElementById('filter-rol').value;
            const tbody = document.querySelector('#usuarios-section .data-table tbody');
            const thead = document.querySelector('#usuarios-section .data-table thead tr');
            tbody.innerHTML = '';
            usuarios = JSON.parse(localStorage.getItem('users_list')) || [];
            
            if (filter === 'admin') {
                thead.innerHTML = `
                    <th>Nombre completo</th>
                    <th>Email</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                `;
                usuarios['empleados'].forEach((u, idx) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${u.nombre_completo}</td>
                        <td>${u.email}</td>
                        <td><span class="status ${u.activo === 'S' ? 'active' : 'inactive'}">${u.activo === 'S' ? 'Activo' : 'Inactivo'}</span></td>
                        <td class="actions">
                            <button class="action-btn view" title="Ver detalles" onclick="mostrarModal('empleado', ${idx})"><i class="fas fa-eye"></i></button>
                            <button class="action-btn assign-role" title="Asignar Rol" onclick="abrirModalRolUsuario(${u.id_usuario}, '${u.nombre_completo.replace(/'/g, '\'')}', ${u.id_rol})"><i class="fas fa-user-tag"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (filter === 'proveedor') {
                thead.innerHTML = `
                    <th>Denominación comercial</th>
                    <th>Email</th>
                    <th>Página web</th>
                    <th>Acciones</th>
                `;
                usuarios['proveedores'].forEach((u, idx) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${u.denominacion_comercial || ''}</td>
                        <td>${u.email}</td>
                        <td>${u.pagina_web || ''}</td>
                        <td class="actions">
                            <button class="action-btn view" title="Ver detalles" onclick="mostrarModal('proveedor', ${idx})"><i class="fas fa-eye"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (filter === 'cliente_natural') {
                thead.innerHTML = `
                    <th>Nombre completo</th>
                    <th>RIF</th>
                    <th>Cédula</th>
                    <th>Acciones</th>
                `;
                usuarios['clientes_naturales'].forEach((u, idx) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${u.nombre_completo}</td>
                        <td>${u.rif || ''}</td>
                        <td>${u.cedula || ''}</td>
                        <td class="actions">
                            <button class="action-btn view" title="Ver detalles" onclick="mostrarModal('cliente_natural', ${idx})"><i class="fas fa-eye"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (filter === 'cliente_juridico') {
                thead.innerHTML = `
                    <th>Email</th>
                    <th>Razón social</th>
                    <th>Denominación comercial</th>
                    <th>RIF</th>
                    <th>Acciones</th>
                `;
                usuarios['clientes_juridicos'].forEach((u, idx) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${u.email}</td>
                        <td>${u.razon_social || ''}</td>
                        <td>${u.denominacion_comercial || ''}</td>
                        <td>${u.rif || ''}</td>
                        <td class="actions">
                            <button class="action-btn view" title="Ver detalles" onclick="mostrarModal('cliente_juridico', ${idx})"><i class="fas fa-eye"></i></button>
                        </td>
                    </tr>`;
                });
            }
        }

        // Función para renderizar tabla de roles
        async function renderRolesTable() {
            try {
                const res = await fetch('http://localhost:3000/roles');
                if (!res.ok) throw new Error('Error al cargar roles');
                const { roles } = await res.json();
                
                const rolesTbody = document.querySelector('#roles-section .data-table tbody');
                rolesTbody.innerHTML = '';
                
                roles.forEach(rol => {
                    rolesTbody.innerHTML += `
                        <tr>
                            <td>${rol.id_rol}</td>
                            <td>${rol.nombre_rol}</td>
                            <td>${rol.privilegios.join(', ') || 'Sin privilegios'}</td>
                            <td class="actions">
                                <button class="action-btn edit" title="Editar" data-rol-id="${rol.id_rol}" data-rol-nombre="${rol.nombre_rol}" data-rol-privilegios='${JSON.stringify(rol.privilegios)}'><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                // Agregar event listeners a los botones de editar
                document.querySelectorAll('#roles-section .action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-rol-id'));
                        const nombre = this.getAttribute('data-rol-nombre');
                        const privilegios = JSON.parse(this.getAttribute('data-rol-privilegios'));
                        editRole(id, nombre, privilegios);
                    });
                });
            } catch (err) {
                console.error('Error al cargar roles:', err);
                const rolesTbody = document.querySelector('#roles-section .data-table tbody');
                rolesTbody.innerHTML = '<tr><td colspan="4">Error al cargar roles.</td></tr>';
            }
        }

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos del usuario
            const datosUsuario = localStorage.getItem("user");
            if (datosUsuario) {
                const usuario = JSON.parse(datosUsuario);
                if(usuario.nombre) document.getElementById("nombre-usuario").textContent = usuario.nombre;
                if(usuario.email) document.getElementById("email-usuario").textContent = usuario.email;
            }

            // Logout handler
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    localStorage.removeItem("user");
                    localStorage.removeItem("users_list");
                    window.location.href = "inicio.html";
                });
            }

            // Cargar usuarios al montar
            fetch('http://localhost:3000/user/usuarios')
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    localStorage.setItem('users_list', JSON.stringify(data));
                    renderUsuariosTable();
                })
                .catch(err => {
                    console.error('Error cargando usuarios:', err);
                });

            // Filtro de roles
            document.getElementById('filter-rol').addEventListener('change', function() {
                renderUsuariosTable();
                actualizarBotonNuevoUsuario();
            });

            // Navegación de secciones
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Update active link
                    navLinks.forEach(l => l.parentElement.classList.remove('active'));
                    this.parentElement.classList.add('active');

                    // Show correct section
                    const sectionId = this.getAttribute('data-section');
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId + '-section').classList.add('active');

                    // Load data if it's the roles section
                    if (sectionId === 'roles') {
                        renderRolesTable();
                    }
                });
            });

            // Botón agregar rol
            const addRolBtn = document.getElementById('add-rol-btn');
            addRolBtn.addEventListener('click', () => {
                resetRolModal();
                document.getElementById('rol-modal').classList.add('active');
            });

            // Cerrar modal de roles
            document.getElementById('close-rol-modal').addEventListener('click', resetRolModal);

            // Formulario de roles
            document.getElementById('rol-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Formulario enviado, editingRoleId:', editingRoleId);
                
                const nombre = document.getElementById('rol-nombre').value;
                const permisos = {
                    crear: document.querySelector('#rol-form input[name="crear"]').checked,
                    eliminar: document.querySelector('#rol-form input[name="eliminar"]').checked,
                    actualizar: document.querySelector('#rol-form input[name="actualizar"]').checked,
                    leer: document.querySelector('#rol-form input[name="leer"]').checked
                };

                console.log('Datos del formulario:', { nombre, permisos, editingRoleId });

                try {
                    let res;
                    if (editingRoleId) {
                        // Modo edición
                        console.log('Enviando PUT request para editar rol:', editingRoleId);
                        res = await fetch("http://localhost:3000/roles/" + editingRoleId, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nombre, permisos })
                        });
                    } else {
                        // Modo creación
                        console.log('Enviando POST request para crear rol');
                        res = await fetch('http://localhost:3000/roles', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nombre, permisos })
                        });
                    }

                    if (res.ok) {
                        console.log('Operación exitosa, reseteando formulario');
                        resetRolModal();
                        await renderRolesTable(); // Refresh the list
                    } else {
                        const errorData = await res.json();
                        const action = editingRoleId ? 'actualizar' : 'crear';
                        alert(`Error al ${action} el rol: ${errorData.error}`);
                    }
                } catch (err) {
                    console.error('Error de conexión:', err);
                    const action = editingRoleId ? 'actualizar' : 'crear';
                    alert(`Error de conexión al ${action} el rol.`);
                }
            });

            // Cerrar modales al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (e.target.id === 'rol-modal') {
                    resetRolModal();
                }
                if (e.target.id === 'close-modal' || e.target.id === 'usuario-modal') {
                    document.getElementById('usuario-modal').classList.remove('active');
                }
            });

            // Cambia el texto y visibilidad del botón de nuevo usuario según el filtro
            function actualizarBotonNuevoUsuario() {
                const btn = document.getElementById('add-usuario-btn');
                const filter = document.getElementById('filter-rol').value;
                if (filter === 'admin') {
                    btn.style.display = '';
                    btn.textContent = 'Nuevo Empleado';
                } else {
                    btn.style.display = 'none';
                }
            }
            actualizarBotonNuevoUsuario();

            // Abrir modal de nuevo empleado
            const addUsuarioBtn = document.getElementById('add-usuario-btn');
            if (addUsuarioBtn) {
                addUsuarioBtn.onclick = function() {
                    document.getElementById('nuevo-empleado-form').reset();
                    document.getElementById('nuevo-empleado-modal').classList.add('active');
                    // Cargar selects de estado, municipio y parroquia usando lugares.js
                    const estadoSelect = document.getElementById('nuevo-empleado-estado');
                    const municipioSelect = document.getElementById('nuevo-empleado-municipio');
                    const parroquiaSelect = document.getElementById('nuevo-empleado-parroquia');
                    poblarEstados(estadoSelect, function() {
                        poblarMunicipios(municipioSelect, estadoSelect.value, function() {
                            poblarParroquias(parroquiaSelect, estadoSelect.value, municipioSelect.value);
                        });
                        parroquiaSelect.innerHTML = '<option value="">Seleccione Parroquia</option>';
                    });
                    municipioSelect.innerHTML = '<option value="">Seleccione Municipio</option>';
                    parroquiaSelect.innerHTML = '<option value="">Seleccione Parroquia</option>';
                };
            }
            // Cerrar modal de nuevo empleado
            const closeNuevoEmpleadoBtn = document.getElementById('close-nuevo-empleado-modal');
            if (closeNuevoEmpleadoBtn) {
                closeNuevoEmpleadoBtn.onclick = function() {
                    document.getElementById('nuevo-empleado-modal').classList.remove('active');
                };
            }
        });

        // Hacer funciones globales
        window.editRole = editRole;
        window.mostrarModal = mostrarModal;

        // Abrir modal de asignación de rol
        async function abrirModalRolUsuario(idUsuario, nombreUsuario, idRolActual) {
            usuarioSeleccionadoId = idUsuario;
            document.getElementById('nombre-usuario-rol').textContent = nombreUsuario;
            // Obtener todos los roles
            const rolesRes = await fetch('http://localhost:3000/roles');
            const { roles } = await rolesRes.json();

            // Ordenar: el rol actual primero, luego los demás por nombre
            roles.sort((a, b) => {
                if (a.id_rol === idRolActual) return -1;
                if (b.id_rol === idRolActual) return 1;
                return a.nombre_rol.localeCompare(b.nombre_rol);
            });

            // Renderizar select
            const select = document.getElementById('select-rol');
            select.innerHTML = '';
            roles.forEach(rol => {
                select.innerHTML += `<option value="${rol.id_rol}" ${rol.id_rol === idRolActual ? 'selected' : ''}>${rol.nombre_rol}</option>`;
            });
            document.getElementById('asignar-rol-modal').classList.add('active');
        }
        document.getElementById('close-asignar-rol-modal').onclick = function() {
            document.getElementById('asignar-rol-modal').classList.remove('active');
        };
        document.getElementById('asignar-rol-form').onsubmit = async function(e) {
            e.preventDefault();
            const id_rol = parseInt(document.getElementById('select-rol').value);
            try {
                const res = await fetch(`http://localhost:3000/roles/usuario/${usuarioSeleccionadoId}/cambiar-rol`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_rol })
                });
                if (res.ok) {
                    alert('Rol actualizado correctamente');
                    document.getElementById('asignar-rol-modal').classList.remove('active');
                    // Opcional: refrescar la tabla de usuarios empleados aquí
                } else {
                    alert('Error al actualizar el rol');
                }
            } catch (err) {
                alert('Error de conexión');
            }
        };

        document.getElementById('nuevo-empleado-form').onsubmit = async function(e) {
            e.preventDefault();
            const cedula = document.getElementById('nuevo-empleado-cedula').value.trim();
            const primer_nombre = document.getElementById('nuevo-empleado-primer-nombre').value.trim();
            const segundo_nombre = document.getElementById('nuevo-empleado-segundo-nombre').value.trim();
            const primer_apellido = document.getElementById('nuevo-empleado-primer-apellido').value.trim();
            const segundo_apellido = document.getElementById('nuevo-empleado-segundo-apellido').value.trim();
            const direccion = document.getElementById('nuevo-empleado-direccion').value.trim();
            const lugar_id_lugar = document.getElementById('nuevo-empleado-parroquia').value;
            const correo = document.getElementById('nuevo-usuario-correo').value.trim();
            const contrasena = document.getElementById('nuevo-usuario-contrasena').value;

            // Separar correo en nombre y extension
            const [correo_nombre, correo_extension] = correo.split('@');
            if (!correo_nombre || !correo_extension) {
                alert('Correo inválido. Debe tener formato usuario@dominio');
                return;
            }

            const data = {
                cedula,
                primer_nombre,
                segundo_nombre,
                primer_apellido,
                segundo_apellido,
                direccion,
                lugar_id_lugar,
                correo_nombre,
                correo_extension,
                contrasena
            };

            try {
                const res = await fetch('http://localhost:3000/user/empleados', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Empleado creado exitosamente');
                    document.getElementById('nuevo-empleado-modal').classList.remove('active');
                    // Agregar el nuevo empleado al localStorage y refrescar la tabla
                    // 1. Obtener el objeto actual de usuarios
                    let usuariosLS = JSON.parse(localStorage.getItem('users_list')) || {};
                    if (!usuariosLS['empleados']) usuariosLS['empleados'] = [];
                    // 2. Crear el objeto del nuevo empleado (con los campos mínimos para la tabla)
                    const nuevoEmpleado = {
                        nombre_completo: primer_nombre + (segundo_nombre ? ' ' + segundo_nombre : '') + ' ' + primer_apellido + (segundo_apellido ? ' ' + segundo_apellido : ''),
                        email: correo_nombre + '@' + correo_extension,
                        cedula: cedula,
                        direccion_especifica: direccion,
                        activo: 'S',
                        // Los siguientes campos pueden quedar vacíos o null si no se tienen en el frontend
                        id_usuario: null, // No lo tenemos hasta recargar desde backend
                        id_rol: null // No lo tenemos hasta recargar desde backend
                    };
                    usuariosLS['empleados'].push(nuevoEmpleado);
                    localStorage.setItem('users_list', JSON.stringify(usuariosLS));
                    renderUsuariosTable();
                } else {
                    const errorData = await res.json();
                    alert('Error al crear el empleado: ' + (errorData.error || ''));
                }
            } catch (err) {
                alert('Error de conexión al crear el empleado');
            }
        };
    </script>
</body>
</html> 